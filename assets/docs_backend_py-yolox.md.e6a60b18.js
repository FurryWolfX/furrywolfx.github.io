import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.a5795de3.js";const m=JSON.parse('{"title":"使用 YOLOX 进行目标检测训练","description":"","frontmatter":{"title":"使用 YOLOX 进行目标检测训练","date":"2023-07-23T12:00:00.000Z","tags":["Python"]},"headers":[],"relativePath":"docs/backend/py-yolox.md","filePath":"docs/backend/py-yolox.md"}'),p={name:"docs/backend/py-yolox.md"},o=l(`<h1 id="使用-yolox-进行目标检测训练" tabindex="-1">使用 YOLOX 进行目标检测训练 <a class="header-anchor" href="#使用-yolox-进行目标检测训练" aria-label="Permalink to &quot;使用 YOLOX 进行目标检测训练&quot;">​</a></h1><h2 id="开始" tabindex="-1">开始 <a class="header-anchor" href="#开始" aria-label="Permalink to &quot;开始&quot;">​</a></h2><div align="center"><img src="https://github.com/Megvii-BaseDetection/YOLOX/raw/main/assets/logo.png" width="350"></div><img src="https://github.com/Megvii-BaseDetection/YOLOX/raw/main/assets/demo.png"><p>从这里下载代码：<a href="https://github.com/Megvii-BaseDetection/YOLOX" target="_blank" rel="noreferrer">https://github.com/Megvii-BaseDetection/YOLOX</a></p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>YOLOX 是一种目标检测模型，它是基于 YOLO 系列（You Only Look Once）的最新发展。YOLOX 模型具有快速、准确和高效的特点，在计算机视觉领域中被广泛应用。</p><p>相比于传统的目标检测模型，YOLOX 具有以下几个显著的特点：</p><ol><li>高精度：YOLOX 采用了一种新的解耦策略，通过设计“头”和“骨干”网络结构的不同组合，可以实现高精度的目标检测。同时，YOLOX 还采用了一种自适应权重融合策略，可以平衡不同尺度的特征图之间的信息。</li><li>快速：YOLOX 具有高效的运行速度，可以实现实时目标检测。它通过优化网络结构和使用高效的推理算法，从而在不降低准确性的情况下提高了检测速度。</li><li>可扩展性：YOLOX 的设计具有很高的可扩展性，可以在不同的场景和任务中灵活应用。它可以适应不同尺度和大小的目标，同时还支持多种视觉任务，如目标检测、实例分割等。</li><li>开源和易用：YOLOX 是一个开源项目，提供了完整的代码和预训练模型，方便研究人员和开发者进行使用和扩展。</li></ol></div><h2 id="第一步-使用-labelme-进行图片标注" tabindex="-1">第一步：使用 labelme 进行图片标注 <a class="header-anchor" href="#第一步-使用-labelme-进行图片标注" aria-label="Permalink to &quot;第一步：使用 labelme 进行图片标注&quot;">​</a></h2><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Labelme 是一个开源的图像标注工具，用于创建和编辑图像标注数据集。它是由麻省理工学院计算机科学与人工智能实验室（MIT CSAIL）开发的，旨在为计算机视觉研究人员和开发者提供一个简单易用的标注工具。</p><p>Labelme 的主要特点和功能包括：</p><ol><li>图像标注：Labelme 允许用户在图像上绘制各种形状，如矩形、多边形、线条等，以标注出感兴趣的目标或区域。用户可以选择不同的标注工具和颜色，以便清晰可见地标注图像。</li><li>标注数据保存：Labelme 支持将标注数据保存为 JSON 文件格式，其中包含了标注的形状、位置和标签等信息。这些标注数据可以用于训练计算机视觉模型，如目标检测、图像分割等任务。</li><li>标注数据可视化：Labelme 可以加载和显示已标注的图像和标注数据，以便用户查看和验证标注结果。用户可以轻松地切换不同图像的显示，以及在图像上显示标注的结果。</li><li>标注数据编辑：Labelme 允许用户对已标注的数据进行编辑和修改。用户可以添加、删除或修改标注的形状和标签，以便进行纠正或完善标注结果。</li><li>标注数据集管理：Labelme 支持管理多个标注数据集，用户可以方便地加载和切换不同的数据集，以便进行比较和分析。</li></ol></div><p>生成如下结构的文件：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">labelme</span></span>
<span class="line"><span style="color:#e1e4e8;">- x.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">- x.json</span></span>
<span class="line"><span style="color:#e1e4e8;">- y.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">- y.json</span></span>
<span class="line"><span style="color:#e1e4e8;">- ...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">labelme</span></span>
<span class="line"><span style="color:#24292e;">- x.jpg</span></span>
<span class="line"><span style="color:#24292e;">- x.json</span></span>
<span class="line"><span style="color:#24292e;">- y.jpg</span></span>
<span class="line"><span style="color:#24292e;">- y.json</span></span>
<span class="line"><span style="color:#24292e;">- ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="第二步-数据集转换到-coco-格式" tabindex="-1">第二步：数据集转换到 COCO 格式 <a class="header-anchor" href="#第二步-数据集转换到-coco-格式" aria-label="Permalink to &quot;第二步：数据集转换到 COCO 格式&quot;">​</a></h2><div class="info custom-block"><p class="custom-block-title">INFO</p><p>COCO（Common Objects in Context）是一种通用的图像数据集格式，用于目标检测、图像分割和关键点检测等计算机视觉任务。COCO 数据集格式由微软研究院提出，并已成为计算机视觉领域中最常用的数据集之一。</p><p>COCO 数据集格式的主要特点和组成部分包括：</p><ol><li>图像：COCO 数据集包含大量的图像，每个图像都有唯一的标识符（ID）。这些图像可以来自不同的来源，如网络、摄像头等。</li><li>标注：对于每个图像，COCO 数据集提供了对应的标注信息。标注信息包括目标的边界框（Bounding Box）位置、目标类别、图像分割掩码、关键点位置等。每个标注都有一个唯一的标识符（ID），并与对应的图像关联。</li><li>类别：COCO 数据集定义了一组常见的目标类别，如人、动物、车辆、家具等。每个类别都有一个唯一的标识符（ID）和一个易于理解的名称。</li><li>标注文件：COCO 数据集的标注信息以 JSON 文件的形式进行存储。标注文件包含了图像和标注的详细信息，可以通过解析 JSON 文件来获取图像和标注数据。</li></ol><p>COCO 数据集格式的优点在于其丰富的标注信息和广泛的应用领域。通过 COCO 格式，研究人员和开发者可以方便地使用和共享大规模的图像数据集，从而促进计算机视觉算法的研究和发展。此外，COCO 数据集还提供了评估指标和基准结果，可以用于算法性能的比较和评估。</p><p>需要注意的是，COCO 数据集格式是一种通用的格式，并不限定于特定的数据集。因此，可以根据具体的任务和需求，使用 COCO 格式进行数据集的创建、标注和管理。</p></div><p>使用 <code>tools/labelme2coco.py</code> 将 <code>labelme</code> 格式转换成 <code>coco</code> 格式</p><div class="language-py vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#!/usr/bin/env python</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> argparse</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> collections</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> datetime</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> glob</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> json</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> os</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> os.path </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> osp</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> sys</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> uuid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> imgviz</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> numpy </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> labelme</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> yolox.data </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">COCO_CLASSES</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">try</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> pycocotools.mask</span></span>
<span class="line"><span style="color:#F97583;">except</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ImportError</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Please install pycocotools:</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">    pip install pycocotools</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    sys.exit(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">():</span></span>
<span class="line"><span style="color:#E1E4E8;">    parser </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> argparse.ArgumentParser(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FFAB70;">formatter_class</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">argparse.ArgumentDefaultsHelpFormatter</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    parser.add_argument(</span><span style="color:#9ECBFF;">&quot;input_dir&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">help</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;input annotated directory&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    parser.add_argument(</span><span style="color:#9ECBFF;">&quot;output_dir&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">help</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;output dataset directory&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># parser.add_argument(&quot;--labels&quot;, help=&quot;labels file&quot;, required=True)</span></span>
<span class="line"><span style="color:#E1E4E8;">    parser.add_argument(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&quot;--noviz&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">help</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;no visualization&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">action</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;store_true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    args </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> parser.parse_args()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> osp.exists(args.output_dir):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Output directory already exists:&quot;</span><span style="color:#E1E4E8;">, args.output_dir)</span></span>
<span class="line"><span style="color:#E1E4E8;">        sys.exit(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    os.makedirs(args.output_dir)</span></span>
<span class="line"><span style="color:#E1E4E8;">    os.makedirs(osp.join(args.output_dir, </span><span style="color:#9ECBFF;">&quot;JPEGImages&quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> args.noviz:</span></span>
<span class="line"><span style="color:#E1E4E8;">        os.makedirs(osp.join(args.output_dir, </span><span style="color:#9ECBFF;">&quot;Visualization&quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Creating dataset:&quot;</span><span style="color:#E1E4E8;">, args.output_dir)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    now </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> datetime.datetime.now()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    data </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dict</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FFAB70;">info</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">dict</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#FFAB70;">description</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#FFAB70;">url</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#FFAB70;">version</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#FFAB70;">year</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">now.year,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#FFAB70;">contributor</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#FFAB70;">date_created</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">now.strftime(</span><span style="color:#9ECBFF;">&quot;%Y-%m-</span><span style="color:#79B8FF;">%d</span><span style="color:#9ECBFF;"> %H:%M:%S.</span><span style="color:#79B8FF;">%f</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ),</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FFAB70;">licenses</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">dict</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">url</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">name</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            )</span></span>
<span class="line"><span style="color:#E1E4E8;">        ],</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FFAB70;">images</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># license, url, file_name, height, width, date_captured, id</span></span>
<span class="line"><span style="color:#E1E4E8;">        ],</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FFAB70;">type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;instances&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FFAB70;">annotations</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># segmentation, area, iscrowd, image_id, bbox, category_id, id</span></span>
<span class="line"><span style="color:#E1E4E8;">        ],</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FFAB70;">categories</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># supercategory, id, name</span></span>
<span class="line"><span style="color:#E1E4E8;">        ],</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    class_name_to_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">    labels </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">list</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">COCO_CLASSES</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    labels.insert(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;__ignore__&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i, line </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">enumerate</span><span style="color:#E1E4E8;">(labels):</span></span>
<span class="line"><span style="color:#E1E4E8;">        class_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># starts with -1</span></span>
<span class="line"><span style="color:#E1E4E8;">        class_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> line.strip()</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> class_id </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">assert</span><span style="color:#E1E4E8;"> class_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;__ignore__&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">continue</span></span>
<span class="line"><span style="color:#E1E4E8;">        class_name_to_id[class_name] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> class_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        data[</span><span style="color:#9ECBFF;">&quot;categories&quot;</span><span style="color:#E1E4E8;">].append(</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">dict</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">supercategory</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">id</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">class_id,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">name</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">class_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            )</span></span>
<span class="line"><span style="color:#E1E4E8;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    out_ann_file </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> osp.join(args.output_dir, </span><span style="color:#9ECBFF;">&quot;annotations.json&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    label_files </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> glob.glob(osp.join(args.input_dir, </span><span style="color:#9ECBFF;">&quot;*.json&quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> image_id, filename </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">enumerate</span><span style="color:#E1E4E8;">(label_files):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Generating dataset from:&quot;</span><span style="color:#E1E4E8;">, filename)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        label_file </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> labelme.LabelFile(</span><span style="color:#FFAB70;">filename</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">filename)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        base </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> osp.splitext(osp.basename(filename))[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        out_img_file </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> osp.join(args.output_dir, </span><span style="color:#9ECBFF;">&quot;JPEGImages&quot;</span><span style="color:#E1E4E8;">, base </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;.jpg&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        img </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> labelme.utils.img_data_to_arr(label_file.imageData)</span></span>
<span class="line"><span style="color:#E1E4E8;">        imgviz.io.imsave(out_img_file, img)</span></span>
<span class="line"><span style="color:#E1E4E8;">        data[</span><span style="color:#9ECBFF;">&quot;images&quot;</span><span style="color:#E1E4E8;">].append(</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">dict</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">license</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">url</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">file_name</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">osp.relpath(out_img_file, osp.dirname(out_ann_file)),</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">height</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">img.shape[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">width</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">img.shape[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">date_captured</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#FFAB70;">id</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">image_id,</span></span>
<span class="line"><span style="color:#E1E4E8;">            )</span></span>
<span class="line"><span style="color:#E1E4E8;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        masks </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}  </span><span style="color:#6A737D;"># for area</span></span>
<span class="line"><span style="color:#E1E4E8;">        segmentations </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> collections.defaultdict(</span><span style="color:#79B8FF;">list</span><span style="color:#E1E4E8;">)  </span><span style="color:#6A737D;"># for segmentation</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> shape </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> label_file.shapes:</span></span>
<span class="line"><span style="color:#E1E4E8;">            points </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> shape[</span><span style="color:#9ECBFF;">&quot;points&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">            label </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> shape[</span><span style="color:#9ECBFF;">&quot;label&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">            group_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> shape.get(</span><span style="color:#9ECBFF;">&quot;group_id&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            shape_type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> shape.get(</span><span style="color:#9ECBFF;">&quot;shape_type&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;polygon&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            mask </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> labelme.utils.shape_to_mask(</span></span>
<span class="line"><span style="color:#E1E4E8;">                img.shape[:</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">], points, shape_type</span></span>
<span class="line"><span style="color:#E1E4E8;">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> group_id </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                group_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> uuid.uuid1()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            instance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (label, group_id)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> instance </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> masks:</span></span>
<span class="line"><span style="color:#E1E4E8;">                masks[instance] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> masks[instance] </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> mask</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                masks[instance] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mask</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> shape_type </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;rectangle&quot;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                (x1, y1), (x2, y2) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> points</span></span>
<span class="line"><span style="color:#E1E4E8;">                x1, x2 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sorted</span><span style="color:#E1E4E8;">([x1, x2])</span></span>
<span class="line"><span style="color:#E1E4E8;">                y1, y2 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sorted</span><span style="color:#E1E4E8;">([y1, y2])</span></span>
<span class="line"><span style="color:#E1E4E8;">                points </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [x1, y1, x2, y1, x2, y2, x1, y2]</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> shape_type </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;circle&quot;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                (x1, y1), (x2, y2) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> points</span></span>
<span class="line"><span style="color:#E1E4E8;">                r </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> np.linalg.norm([x2 </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> x1, y2 </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> y1])</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;"># r(1-cos(a/2))&lt;x, a=2*pi/N =&gt; N&gt;pi/arccos(1-x/r)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;"># x: tolerance of the gap between the arc and the line segment</span></span>
<span class="line"><span style="color:#E1E4E8;">                n_points_circle </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">max</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">int</span><span style="color:#E1E4E8;">(np.pi </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> np.arccos(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> r)), </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> np.arange(n_points_circle)</span></span>
<span class="line"><span style="color:#E1E4E8;">                x </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> x1 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> np.sin(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> np.pi </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> n_points_circle </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> i)</span></span>
<span class="line"><span style="color:#E1E4E8;">                y </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> y1 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> np.cos(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> np.pi </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> n_points_circle </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> i)</span></span>
<span class="line"><span style="color:#E1E4E8;">                points </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> np.stack((x, y), </span><span style="color:#FFAB70;">axis</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">).flatten().tolist()</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                points </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> np.asarray(points).flatten().tolist()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            segmentations[instance].append(points)</span></span>
<span class="line"><span style="color:#E1E4E8;">        segmentations </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dict</span><span style="color:#E1E4E8;">(segmentations)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> instance, mask </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> masks.items():</span></span>
<span class="line"><span style="color:#E1E4E8;">            cls_name, group_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> instance</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> cls_name </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> class_name_to_id:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">continue</span></span>
<span class="line"><span style="color:#E1E4E8;">            cls_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> class_name_to_id[cls_name]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            mask </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> np.asfortranarray(mask.astype(np.uint8))</span></span>
<span class="line"><span style="color:#E1E4E8;">            mask </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> pycocotools.mask.encode(mask)</span></span>
<span class="line"><span style="color:#E1E4E8;">            area </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">float</span><span style="color:#E1E4E8;">(pycocotools.mask.area(mask))</span></span>
<span class="line"><span style="color:#E1E4E8;">            bbox </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> pycocotools.mask.toBbox(mask).flatten().tolist()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            data[</span><span style="color:#9ECBFF;">&quot;annotations&quot;</span><span style="color:#E1E4E8;">].append(</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">dict</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(data[</span><span style="color:#9ECBFF;">&quot;annotations&quot;</span><span style="color:#E1E4E8;">]),</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">image_id</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">image_id,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">category_id</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">cls_id,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">segmentation</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">segmentations[instance],</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">area</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">area,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">bbox</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">bbox,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">iscrowd</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                )</span></span>
<span class="line"><span style="color:#E1E4E8;">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> args.noviz:</span></span>
<span class="line"><span style="color:#E1E4E8;">            viz </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> img</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> masks:</span></span>
<span class="line"><span style="color:#E1E4E8;">                labels, captions, masks </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">zip</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">                        (class_name_to_id[cnm], cnm, msk)</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (cnm, gid), msk </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> masks.items()</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> cnm </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> class_name_to_id</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ]</span></span>
<span class="line"><span style="color:#E1E4E8;">                )</span></span>
<span class="line"><span style="color:#E1E4E8;">                viz </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> imgviz.instances2rgb(</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">image</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">img,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">labels</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">labels,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">masks</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">masks,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">captions</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">captions,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">font_size</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#FFAB70;">line_width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                )</span></span>
<span class="line"><span style="color:#E1E4E8;">            out_viz_file </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> osp.join(</span></span>
<span class="line"><span style="color:#E1E4E8;">                args.output_dir, </span><span style="color:#9ECBFF;">&quot;Visualization&quot;</span><span style="color:#E1E4E8;">, base </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;.jpg&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            )</span></span>
<span class="line"><span style="color:#E1E4E8;">            imgviz.io.imsave(out_viz_file, viz)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">open</span><span style="color:#E1E4E8;">(out_ann_file, </span><span style="color:#9ECBFF;">&quot;w&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> f:</span></span>
<span class="line"><span style="color:#E1E4E8;">        json.dump(data, f)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">__name__</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;__main__&quot;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    main()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#!/usr/bin/env python</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> argparse</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> collections</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> datetime</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> glob</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> json</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> os</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> os.path </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> osp</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> sys</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> uuid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> imgviz</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> numpy </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> labelme</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> yolox.data </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">COCO_CLASSES</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">try</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> pycocotools.mask</span></span>
<span class="line"><span style="color:#D73A49;">except</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ImportError</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Please install pycocotools:</span><span style="color:#005CC5;">\\n\\n</span><span style="color:#032F62;">    pip install pycocotools</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    sys.exit(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    parser </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> argparse.ArgumentParser(</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">formatter_class</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">argparse.ArgumentDefaultsHelpFormatter</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    parser.add_argument(</span><span style="color:#032F62;">&quot;input_dir&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">help</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;input annotated directory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    parser.add_argument(</span><span style="color:#032F62;">&quot;output_dir&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">help</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;output dataset directory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># parser.add_argument(&quot;--labels&quot;, help=&quot;labels file&quot;, required=True)</span></span>
<span class="line"><span style="color:#24292E;">    parser.add_argument(</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;--noviz&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">help</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;no visualization&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">action</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;store_true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> parser.parse_args()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> osp.exists(args.output_dir):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Output directory already exists:&quot;</span><span style="color:#24292E;">, args.output_dir)</span></span>
<span class="line"><span style="color:#24292E;">        sys.exit(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    os.makedirs(args.output_dir)</span></span>
<span class="line"><span style="color:#24292E;">    os.makedirs(osp.join(args.output_dir, </span><span style="color:#032F62;">&quot;JPEGImages&quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> args.noviz:</span></span>
<span class="line"><span style="color:#24292E;">        os.makedirs(osp.join(args.output_dir, </span><span style="color:#032F62;">&quot;Visualization&quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Creating dataset:&quot;</span><span style="color:#24292E;">, args.output_dir)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    now </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> datetime.datetime.now()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    data </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dict</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">info</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">dict</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">description</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">url</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">version</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">year</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">now.year,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">contributor</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">date_created</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">now.strftime(</span><span style="color:#032F62;">&quot;%Y-%m-</span><span style="color:#005CC5;">%d</span><span style="color:#032F62;"> %H:%M:%S.</span><span style="color:#005CC5;">%f</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">        ),</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">licenses</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">dict</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">url</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">name</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            )</span></span>
<span class="line"><span style="color:#24292E;">        ],</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">images</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># license, url, file_name, height, width, date_captured, id</span></span>
<span class="line"><span style="color:#24292E;">        ],</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;instances&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">annotations</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># segmentation, area, iscrowd, image_id, bbox, category_id, id</span></span>
<span class="line"><span style="color:#24292E;">        ],</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">categories</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># supercategory, id, name</span></span>
<span class="line"><span style="color:#24292E;">        ],</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    class_name_to_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">    labels </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">list</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">COCO_CLASSES</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    labels.insert(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;__ignore__&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i, line </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">enumerate</span><span style="color:#24292E;">(labels):</span></span>
<span class="line"><span style="color:#24292E;">        class_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># starts with -1</span></span>
<span class="line"><span style="color:#24292E;">        class_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> line.strip()</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> class_id </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">assert</span><span style="color:#24292E;"> class_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;__ignore__&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">continue</span></span>
<span class="line"><span style="color:#24292E;">        class_name_to_id[class_name] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> class_id</span></span>
<span class="line"><span style="color:#24292E;">        data[</span><span style="color:#032F62;">&quot;categories&quot;</span><span style="color:#24292E;">].append(</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">dict</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">supercategory</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">id</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">class_id,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">name</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">class_name,</span></span>
<span class="line"><span style="color:#24292E;">            )</span></span>
<span class="line"><span style="color:#24292E;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    out_ann_file </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> osp.join(args.output_dir, </span><span style="color:#032F62;">&quot;annotations.json&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    label_files </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> glob.glob(osp.join(args.input_dir, </span><span style="color:#032F62;">&quot;*.json&quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> image_id, filename </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">enumerate</span><span style="color:#24292E;">(label_files):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Generating dataset from:&quot;</span><span style="color:#24292E;">, filename)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        label_file </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> labelme.LabelFile(</span><span style="color:#E36209;">filename</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">filename)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        base </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> osp.splitext(osp.basename(filename))[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        out_img_file </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> osp.join(args.output_dir, </span><span style="color:#032F62;">&quot;JPEGImages&quot;</span><span style="color:#24292E;">, base </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.jpg&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        img </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> labelme.utils.img_data_to_arr(label_file.imageData)</span></span>
<span class="line"><span style="color:#24292E;">        imgviz.io.imsave(out_img_file, img)</span></span>
<span class="line"><span style="color:#24292E;">        data[</span><span style="color:#032F62;">&quot;images&quot;</span><span style="color:#24292E;">].append(</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">dict</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">license</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">url</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">file_name</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">osp.relpath(out_img_file, osp.dirname(out_ann_file)),</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">height</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">img.shape[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">width</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">img.shape[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">date_captured</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">id</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">image_id,</span></span>
<span class="line"><span style="color:#24292E;">            )</span></span>
<span class="line"><span style="color:#24292E;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        masks </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}  </span><span style="color:#6A737D;"># for area</span></span>
<span class="line"><span style="color:#24292E;">        segmentations </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> collections.defaultdict(</span><span style="color:#005CC5;">list</span><span style="color:#24292E;">)  </span><span style="color:#6A737D;"># for segmentation</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> shape </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> label_file.shapes:</span></span>
<span class="line"><span style="color:#24292E;">            points </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> shape[</span><span style="color:#032F62;">&quot;points&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">            label </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> shape[</span><span style="color:#032F62;">&quot;label&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">            group_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> shape.get(</span><span style="color:#032F62;">&quot;group_id&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            shape_type </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> shape.get(</span><span style="color:#032F62;">&quot;shape_type&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;polygon&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            mask </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> labelme.utils.shape_to_mask(</span></span>
<span class="line"><span style="color:#24292E;">                img.shape[:</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">], points, shape_type</span></span>
<span class="line"><span style="color:#24292E;">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> group_id </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                group_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> uuid.uuid1()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            instance </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (label, group_id)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> instance </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> masks:</span></span>
<span class="line"><span style="color:#24292E;">                masks[instance] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> masks[instance] </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> mask</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                masks[instance] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mask</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> shape_type </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;rectangle&quot;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                (x1, y1), (x2, y2) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> points</span></span>
<span class="line"><span style="color:#24292E;">                x1, x2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sorted</span><span style="color:#24292E;">([x1, x2])</span></span>
<span class="line"><span style="color:#24292E;">                y1, y2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sorted</span><span style="color:#24292E;">([y1, y2])</span></span>
<span class="line"><span style="color:#24292E;">                points </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [x1, y1, x2, y1, x2, y2, x1, y2]</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> shape_type </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;circle&quot;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                (x1, y1), (x2, y2) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> points</span></span>
<span class="line"><span style="color:#24292E;">                r </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.linalg.norm([x2 </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> x1, y2 </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> y1])</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;"># r(1-cos(a/2))&lt;x, a=2*pi/N =&gt; N&gt;pi/arccos(1-x/r)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;"># x: tolerance of the gap between the arc and the line segment</span></span>
<span class="line"><span style="color:#24292E;">                n_points_circle </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">max</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">int</span><span style="color:#24292E;">(np.pi </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> np.arccos(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> r)), </span><span style="color:#005CC5;">12</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.arange(n_points_circle)</span></span>
<span class="line"><span style="color:#24292E;">                x </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> x1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> r </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> np.sin(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> np.pi </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> n_points_circle </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> i)</span></span>
<span class="line"><span style="color:#24292E;">                y </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> y1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> r </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> np.cos(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> np.pi </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> n_points_circle </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> i)</span></span>
<span class="line"><span style="color:#24292E;">                points </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.stack((x, y), </span><span style="color:#E36209;">axis</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">).flatten().tolist()</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                points </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.asarray(points).flatten().tolist()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            segmentations[instance].append(points)</span></span>
<span class="line"><span style="color:#24292E;">        segmentations </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dict</span><span style="color:#24292E;">(segmentations)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> instance, mask </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> masks.items():</span></span>
<span class="line"><span style="color:#24292E;">            cls_name, group_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> instance</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> cls_name </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> class_name_to_id:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">continue</span></span>
<span class="line"><span style="color:#24292E;">            cls_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> class_name_to_id[cls_name]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            mask </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.asfortranarray(mask.astype(np.uint8))</span></span>
<span class="line"><span style="color:#24292E;">            mask </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> pycocotools.mask.encode(mask)</span></span>
<span class="line"><span style="color:#24292E;">            area </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">float</span><span style="color:#24292E;">(pycocotools.mask.area(mask))</span></span>
<span class="line"><span style="color:#24292E;">            bbox </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> pycocotools.mask.toBbox(mask).flatten().tolist()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            data[</span><span style="color:#032F62;">&quot;annotations&quot;</span><span style="color:#24292E;">].append(</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">dict</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(data[</span><span style="color:#032F62;">&quot;annotations&quot;</span><span style="color:#24292E;">]),</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">image_id</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">image_id,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">category_id</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">cls_id,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">segmentation</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">segmentations[instance],</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">area</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">area,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">bbox</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">bbox,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">iscrowd</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                )</span></span>
<span class="line"><span style="color:#24292E;">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> args.noviz:</span></span>
<span class="line"><span style="color:#24292E;">            viz </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> img</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> masks:</span></span>
<span class="line"><span style="color:#24292E;">                labels, captions, masks </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">zip</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">[</span></span>
<span class="line"><span style="color:#24292E;">                        (class_name_to_id[cnm], cnm, msk)</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (cnm, gid), msk </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> masks.items()</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> cnm </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> class_name_to_id</span></span>
<span class="line"><span style="color:#24292E;">                    ]</span></span>
<span class="line"><span style="color:#24292E;">                )</span></span>
<span class="line"><span style="color:#24292E;">                viz </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> imgviz.instances2rgb(</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">image</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">img,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">labels</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">labels,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">masks</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">masks,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">captions</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">captions,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">font_size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">15</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#E36209;">line_width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                )</span></span>
<span class="line"><span style="color:#24292E;">            out_viz_file </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> osp.join(</span></span>
<span class="line"><span style="color:#24292E;">                args.output_dir, </span><span style="color:#032F62;">&quot;Visualization&quot;</span><span style="color:#24292E;">, base </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.jpg&quot;</span></span>
<span class="line"><span style="color:#24292E;">            )</span></span>
<span class="line"><span style="color:#24292E;">            imgviz.io.imsave(out_viz_file, viz)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">open</span><span style="color:#24292E;">(out_ann_file, </span><span style="color:#032F62;">&quot;w&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> f:</span></span>
<span class="line"><span style="color:#24292E;">        json.dump(data, f)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__name__</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;__main__&quot;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    main()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br></div></div><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">coco_cata</span></span>
<span class="line"><span style="color:#e1e4e8;">- JPEGImages</span></span>
<span class="line"><span style="color:#e1e4e8;">  - x.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">  - y.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">- Visualization</span></span>
<span class="line"><span style="color:#e1e4e8;">  - x.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">  - y.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">- annotations.json</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">coco_cata</span></span>
<span class="line"><span style="color:#24292e;">- JPEGImages</span></span>
<span class="line"><span style="color:#24292e;">  - x.jpg</span></span>
<span class="line"><span style="color:#24292e;">  - y.jpg</span></span>
<span class="line"><span style="color:#24292e;">- Visualization</span></span>
<span class="line"><span style="color:#24292e;">  - x.jpg</span></span>
<span class="line"><span style="color:#24292e;">  - y.jpg</span></span>
<span class="line"><span style="color:#24292e;">- annotations.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>最后整理成如下格式：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">coco</span></span>
<span class="line"><span style="color:#e1e4e8;">- annotations</span></span>
<span class="line"><span style="color:#e1e4e8;">  - annotations.json</span></span>
<span class="line"><span style="color:#e1e4e8;">- train2017</span></span>
<span class="line"><span style="color:#e1e4e8;">  - JPEGImages</span></span>
<span class="line"><span style="color:#e1e4e8;">    - x.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">    - y.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">  - Visualization</span></span>
<span class="line"><span style="color:#e1e4e8;">    - x.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">    - y.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">- val2017</span></span>
<span class="line"><span style="color:#e1e4e8;">  - JPEGImages</span></span>
<span class="line"><span style="color:#e1e4e8;">    - x.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">    - y.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">  - Visualization</span></span>
<span class="line"><span style="color:#e1e4e8;">    - x.jpg</span></span>
<span class="line"><span style="color:#e1e4e8;">    - y.jpg</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">coco</span></span>
<span class="line"><span style="color:#24292e;">- annotations</span></span>
<span class="line"><span style="color:#24292e;">  - annotations.json</span></span>
<span class="line"><span style="color:#24292e;">- train2017</span></span>
<span class="line"><span style="color:#24292e;">  - JPEGImages</span></span>
<span class="line"><span style="color:#24292e;">    - x.jpg</span></span>
<span class="line"><span style="color:#24292e;">    - y.jpg</span></span>
<span class="line"><span style="color:#24292e;">  - Visualization</span></span>
<span class="line"><span style="color:#24292e;">    - x.jpg</span></span>
<span class="line"><span style="color:#24292e;">    - y.jpg</span></span>
<span class="line"><span style="color:#24292e;">- val2017</span></span>
<span class="line"><span style="color:#24292e;">  - JPEGImages</span></span>
<span class="line"><span style="color:#24292e;">    - x.jpg</span></span>
<span class="line"><span style="color:#24292e;">    - y.jpg</span></span>
<span class="line"><span style="color:#24292e;">  - Visualization</span></span>
<span class="line"><span style="color:#24292e;">    - x.jpg</span></span>
<span class="line"><span style="color:#24292e;">    - y.jpg</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="第三步-修改-coco-classes" tabindex="-1">第三步：修改 coco classes <a class="header-anchor" href="#第三步-修改-coco-classes" aria-label="Permalink to &quot;第三步：修改 coco classes&quot;">​</a></h2><p><code>yolox/data/datasets/coco_classes.py</code></p><div class="language-py vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#!/usr/bin/env python3</span></span>
<span class="line"><span style="color:#6A737D;"># -*- coding:utf-8 -*-</span></span>
<span class="line"><span style="color:#6A737D;"># Copyright (c) Megvii, Inc. and its affiliates.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">COCO_CLASSES</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;xxx&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;yyy&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#!/usr/bin/env python3</span></span>
<span class="line"><span style="color:#6A737D;"># -*- coding:utf-8 -*-</span></span>
<span class="line"><span style="color:#6A737D;"># Copyright (c) Megvii, Inc. and its affiliates.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">COCO_CLASSES</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;xxx&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;yyy&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="第四步-修改模型训练参数" tabindex="-1">第四步：修改模型训练参数 <a class="header-anchor" href="#第四步-修改模型训练参数" aria-label="Permalink to &quot;第四步：修改模型训练参数&quot;">​</a></h2><p><code>exps/example/custom/yolox_s.py</code></p><div class="language-py vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#!/usr/bin/env python3</span></span>
<span class="line"><span style="color:#6A737D;"># -*- coding:utf-8 -*-</span></span>
<span class="line"><span style="color:#6A737D;"># Copyright (c) Megvii, Inc. and its affiliates.</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> os</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> yolox.data </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">COCO_CLASSES</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> yolox.exp </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> Exp </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> MyExp</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Exp</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">MyExp</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">__init__</span><span style="color:#E1E4E8;">(self):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">super</span><span style="color:#E1E4E8;">(Exp, </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">).</span><span style="color:#79B8FF;">__init__</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.depth </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.33</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.width </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.50</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.exp_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.path.split(os.path.realpath(</span><span style="color:#79B8FF;">__file__</span><span style="color:#E1E4E8;">))[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].split(</span><span style="color:#9ECBFF;">&quot;.&quot;</span><span style="color:#E1E4E8;">)[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># Define yourself dataset path</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.data_dir </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">r</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#DBEDFF;">D:</span><span style="color:#79B8FF;">\\W</span><span style="color:#DBEDFF;">ork</span><span style="color:#85E89D;font-weight:bold;">\\a</span><span style="color:#DBEDFF;">i</span><span style="color:#85E89D;font-weight:bold;">\\Y</span><span style="color:#DBEDFF;">OLOX</span><span style="color:#79B8FF;">\\d</span><span style="color:#DBEDFF;">atasets</span><span style="color:#85E89D;font-weight:bold;">\\c</span><span style="color:#DBEDFF;">oco</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.train_ann </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;annotations.json&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.val_ann </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;annotations.json&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.num_classes </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">COCO_CLASSES</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.max_epoch </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.data_num_workers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.eval_interval </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#!/usr/bin/env python3</span></span>
<span class="line"><span style="color:#6A737D;"># -*- coding:utf-8 -*-</span></span>
<span class="line"><span style="color:#6A737D;"># Copyright (c) Megvii, Inc. and its affiliates.</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> os</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> yolox.data </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">COCO_CLASSES</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> yolox.exp </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Exp </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> MyExp</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Exp</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">MyExp</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">(self):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">super</span><span style="color:#24292E;">(Exp, </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">).</span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.depth </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.33</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.width </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.50</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.exp_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.path.split(os.path.realpath(</span><span style="color:#005CC5;">__file__</span><span style="color:#24292E;">))[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">].split(</span><span style="color:#032F62;">&quot;.&quot;</span><span style="color:#24292E;">)[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># Define yourself dataset path</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.data_dir </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">r</span><span style="color:#032F62;">&quot;D:</span><span style="color:#005CC5;">\\W</span><span style="color:#032F62;">ork</span><span style="color:#22863A;font-weight:bold;">\\a</span><span style="color:#032F62;">i</span><span style="color:#22863A;font-weight:bold;">\\Y</span><span style="color:#032F62;">OLOX</span><span style="color:#005CC5;">\\d</span><span style="color:#032F62;">atasets</span><span style="color:#22863A;font-weight:bold;">\\c</span><span style="color:#032F62;">oco&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.train_ann </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;annotations.json&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.val_ann </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;annotations.json&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.num_classes </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">COCO_CLASSES</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.max_epoch </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.data_num_workers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.eval_interval </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="第五步-训练模型" tabindex="-1">第五步：训练模型 <a class="header-anchor" href="#第五步-训练模型" aria-label="Permalink to &quot;第五步：训练模型&quot;">​</a></h2><p>使用 <code>tools/train.py</code> 执行训练。</p><h2 id="最后-in-memory-of-dr-jian-sun" tabindex="-1">最后：In memory of Dr. Jian Sun <a class="header-anchor" href="#最后-in-memory-of-dr-jian-sun" aria-label="Permalink to &quot;最后：In memory of Dr. Jian Sun&quot;">​</a></h2><p>Without the guidance of Dr. Jian Sun, YOLOX would not have been released and open sourced to the community. The passing away of Dr. Jian is a huge loss to the Computer Vision field. We add this section here to express our remembrance and condolences to our captain Dr. Jian. It is hoped that every AI practitioner in the world will stick to the concept of &quot;continuous innovation to expand cognitive boundaries, and extraordinary technology to achieve product value&quot; and move forward all the way.</p><div align="center"><img src="https://github.com/Megvii-BaseDetection/YOLOX/raw/main/assets/sunjian.png" width="200"></div><p>没有孙剑博士的指导，YOLOX 也不会问世并开源给社区使用。 孙剑博士的离去是 CV 领域的一大损失，我们在此特别添加了这个部分来表达对我们的“船长”孙老师的纪念和哀思。 希望世界上的每个 AI 从业者秉持着“持续创新拓展认知边界，非凡科技成就产品价值”的观念，一路向前。</p>`,29),e=[o];function c(r,t,E,y,i,b){return n(),a("div",null,e)}const F=s(p,[["render",c]]);export{m as __pageData,F as default};
