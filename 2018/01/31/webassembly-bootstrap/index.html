<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebAssembly 起步！ | Legend Of WolfX</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.png">
    <script src="/warning.js"></script>
    <meta name="description" content="

WebAssembly 是一种可以在浏览器上运行的二进制可执行格式文件。它将成为浏览器进化史上又一次革命。

自从浏览器问世以来，javascript 就成为浏览器上执行程序的唯一标准，越来越多的应用程序通过 javascript 开发，并运行于浏览器上；而随着浏览器上 h5 程序功能的丰富，也对浏览器提出了更多的挑战。其中一条最为重要的就是性能问题。javascript 是一种弱类型，解释性 ...">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    
    <link rel="preload" href="/assets/css/0.styles.bc3aed26.css" as="style"><link rel="preload" href="/assets/js/app.1da0bb69.js" as="script"><link rel="preload" href="/assets/js/14.55e4c550.js" as="script"><link rel="preload" href="/assets/js/7.84f6b2a8.js" as="script"><link rel="preload" href="/assets/js/104.e613c484.js" as="script"><link rel="prefetch" href="/assets/js/10.5705640b.js"><link rel="prefetch" href="/assets/js/100.2d4d9e7d.js"><link rel="prefetch" href="/assets/js/101.f63a89bb.js"><link rel="prefetch" href="/assets/js/102.c939cad6.js"><link rel="prefetch" href="/assets/js/103.e87a1952.js"><link rel="prefetch" href="/assets/js/105.13322646.js"><link rel="prefetch" href="/assets/js/106.0b5207e5.js"><link rel="prefetch" href="/assets/js/107.a1c332ed.js"><link rel="prefetch" href="/assets/js/108.c414da2f.js"><link rel="prefetch" href="/assets/js/109.8f83e939.js"><link rel="prefetch" href="/assets/js/11.45b718df.js"><link rel="prefetch" href="/assets/js/110.6e8b7546.js"><link rel="prefetch" href="/assets/js/111.47ddfaea.js"><link rel="prefetch" href="/assets/js/112.b43fd0a3.js"><link rel="prefetch" href="/assets/js/113.adfb2c3f.js"><link rel="prefetch" href="/assets/js/114.ceb439a8.js"><link rel="prefetch" href="/assets/js/115.7338874a.js"><link rel="prefetch" href="/assets/js/116.084363c7.js"><link rel="prefetch" href="/assets/js/117.c479ea70.js"><link rel="prefetch" href="/assets/js/118.740418fa.js"><link rel="prefetch" href="/assets/js/119.7977d3a4.js"><link rel="prefetch" href="/assets/js/12.52e6b565.js"><link rel="prefetch" href="/assets/js/120.bf8a6cc1.js"><link rel="prefetch" href="/assets/js/121.7f4e2649.js"><link rel="prefetch" href="/assets/js/122.892416f9.js"><link rel="prefetch" href="/assets/js/123.6f659ecf.js"><link rel="prefetch" href="/assets/js/124.e73898a1.js"><link rel="prefetch" href="/assets/js/125.c883bf63.js"><link rel="prefetch" href="/assets/js/126.eaf1e632.js"><link rel="prefetch" href="/assets/js/127.c3383c38.js"><link rel="prefetch" href="/assets/js/128.09c5fd68.js"><link rel="prefetch" href="/assets/js/129.5da002f2.js"><link rel="prefetch" href="/assets/js/13.2d8ff702.js"><link rel="prefetch" href="/assets/js/130.009adfbc.js"><link rel="prefetch" href="/assets/js/131.ed2e07f2.js"><link rel="prefetch" href="/assets/js/132.85c71e26.js"><link rel="prefetch" href="/assets/js/133.6bf319f6.js"><link rel="prefetch" href="/assets/js/134.91dadb77.js"><link rel="prefetch" href="/assets/js/135.5ced86b0.js"><link rel="prefetch" href="/assets/js/136.d1943bf5.js"><link rel="prefetch" href="/assets/js/137.d712710c.js"><link rel="prefetch" href="/assets/js/138.8621c889.js"><link rel="prefetch" href="/assets/js/139.7c6e757e.js"><link rel="prefetch" href="/assets/js/140.713b765b.js"><link rel="prefetch" href="/assets/js/141.b8426937.js"><link rel="prefetch" href="/assets/js/142.4140c467.js"><link rel="prefetch" href="/assets/js/143.5720dd6a.js"><link rel="prefetch" href="/assets/js/144.5b2afd9d.js"><link rel="prefetch" href="/assets/js/145.fab879c4.js"><link rel="prefetch" href="/assets/js/146.e518355c.js"><link rel="prefetch" href="/assets/js/147.aca6d356.js"><link rel="prefetch" href="/assets/js/148.9a7784e5.js"><link rel="prefetch" href="/assets/js/149.47385d5b.js"><link rel="prefetch" href="/assets/js/15.cbf6ad4a.js"><link rel="prefetch" href="/assets/js/150.59354d20.js"><link rel="prefetch" href="/assets/js/151.160dfb19.js"><link rel="prefetch" href="/assets/js/152.3468e19f.js"><link rel="prefetch" href="/assets/js/153.b4b91d42.js"><link rel="prefetch" href="/assets/js/154.7a92a4cd.js"><link rel="prefetch" href="/assets/js/155.504e7237.js"><link rel="prefetch" href="/assets/js/156.4b2fd82d.js"><link rel="prefetch" href="/assets/js/157.e0c1fce1.js"><link rel="prefetch" href="/assets/js/158.e9e96399.js"><link rel="prefetch" href="/assets/js/159.a828861d.js"><link rel="prefetch" href="/assets/js/16.14d57789.js"><link rel="prefetch" href="/assets/js/160.f9a3384b.js"><link rel="prefetch" href="/assets/js/161.3db0d003.js"><link rel="prefetch" href="/assets/js/162.4adb9cd5.js"><link rel="prefetch" href="/assets/js/163.4e497f08.js"><link rel="prefetch" href="/assets/js/164.61857252.js"><link rel="prefetch" href="/assets/js/165.607930a2.js"><link rel="prefetch" href="/assets/js/166.94ac84d2.js"><link rel="prefetch" href="/assets/js/167.5a2af554.js"><link rel="prefetch" href="/assets/js/168.c72baabc.js"><link rel="prefetch" href="/assets/js/169.a6afeb03.js"><link rel="prefetch" href="/assets/js/17.747906fb.js"><link rel="prefetch" href="/assets/js/170.1cec3ae7.js"><link rel="prefetch" href="/assets/js/171.f61f0bc5.js"><link rel="prefetch" href="/assets/js/172.38588344.js"><link rel="prefetch" href="/assets/js/173.4d97e8fd.js"><link rel="prefetch" href="/assets/js/174.0537bcc9.js"><link rel="prefetch" href="/assets/js/175.465e29e0.js"><link rel="prefetch" href="/assets/js/176.9d386c25.js"><link rel="prefetch" href="/assets/js/177.dbe53764.js"><link rel="prefetch" href="/assets/js/178.b2883b56.js"><link rel="prefetch" href="/assets/js/179.acb4961f.js"><link rel="prefetch" href="/assets/js/18.40a8d0d2.js"><link rel="prefetch" href="/assets/js/180.aaad2c2c.js"><link rel="prefetch" href="/assets/js/181.439040e4.js"><link rel="prefetch" href="/assets/js/182.85f38b4d.js"><link rel="prefetch" href="/assets/js/183.593806cf.js"><link rel="prefetch" href="/assets/js/184.42bc8c2f.js"><link rel="prefetch" href="/assets/js/185.9606126b.js"><link rel="prefetch" href="/assets/js/186.8ac37809.js"><link rel="prefetch" href="/assets/js/187.aadb7ee1.js"><link rel="prefetch" href="/assets/js/188.0e551305.js"><link rel="prefetch" href="/assets/js/189.efde0ed0.js"><link rel="prefetch" href="/assets/js/19.323323fe.js"><link rel="prefetch" href="/assets/js/190.eb299bed.js"><link rel="prefetch" href="/assets/js/191.c7155e3f.js"><link rel="prefetch" href="/assets/js/192.47ea9532.js"><link rel="prefetch" href="/assets/js/193.dd76fbb7.js"><link rel="prefetch" href="/assets/js/194.268b45ff.js"><link rel="prefetch" href="/assets/js/195.3b4859d3.js"><link rel="prefetch" href="/assets/js/196.bbf544cb.js"><link rel="prefetch" href="/assets/js/197.9a206eea.js"><link rel="prefetch" href="/assets/js/198.3cda3f6b.js"><link rel="prefetch" href="/assets/js/199.914d8feb.js"><link rel="prefetch" href="/assets/js/20.01c11e5d.js"><link rel="prefetch" href="/assets/js/200.d48df64f.js"><link rel="prefetch" href="/assets/js/201.9e1cab4a.js"><link rel="prefetch" href="/assets/js/202.1078a481.js"><link rel="prefetch" href="/assets/js/203.afd69b72.js"><link rel="prefetch" href="/assets/js/204.c9678a25.js"><link rel="prefetch" href="/assets/js/205.1eb51746.js"><link rel="prefetch" href="/assets/js/206.0ad0944a.js"><link rel="prefetch" href="/assets/js/207.ea100082.js"><link rel="prefetch" href="/assets/js/208.faacb980.js"><link rel="prefetch" href="/assets/js/209.61c93638.js"><link rel="prefetch" href="/assets/js/21.6c532828.js"><link rel="prefetch" href="/assets/js/210.5beea1d1.js"><link rel="prefetch" href="/assets/js/211.b7e288c0.js"><link rel="prefetch" href="/assets/js/212.76f985ec.js"><link rel="prefetch" href="/assets/js/213.b3e0249c.js"><link rel="prefetch" href="/assets/js/214.95f23932.js"><link rel="prefetch" href="/assets/js/215.82d98623.js"><link rel="prefetch" href="/assets/js/216.af951190.js"><link rel="prefetch" href="/assets/js/217.20f0231b.js"><link rel="prefetch" href="/assets/js/218.3ccdc462.js"><link rel="prefetch" href="/assets/js/22.1038e00c.js"><link rel="prefetch" href="/assets/js/23.1c93cbb8.js"><link rel="prefetch" href="/assets/js/24.f6db29c9.js"><link rel="prefetch" href="/assets/js/25.c8af1a26.js"><link rel="prefetch" href="/assets/js/26.2671fe16.js"><link rel="prefetch" href="/assets/js/27.70790a29.js"><link rel="prefetch" href="/assets/js/28.16cb6531.js"><link rel="prefetch" href="/assets/js/29.a5667c90.js"><link rel="prefetch" href="/assets/js/3.004e578d.js"><link rel="prefetch" href="/assets/js/30.b2b4a71e.js"><link rel="prefetch" href="/assets/js/31.b98c1637.js"><link rel="prefetch" href="/assets/js/32.09fe6a62.js"><link rel="prefetch" href="/assets/js/33.b449fdc8.js"><link rel="prefetch" href="/assets/js/34.caabbdde.js"><link rel="prefetch" href="/assets/js/35.2fc3469f.js"><link rel="prefetch" href="/assets/js/36.c32f595b.js"><link rel="prefetch" href="/assets/js/37.5336f1f2.js"><link rel="prefetch" href="/assets/js/38.5f6134ef.js"><link rel="prefetch" href="/assets/js/39.1fa405e9.js"><link rel="prefetch" href="/assets/js/4.983e1af9.js"><link rel="prefetch" href="/assets/js/40.01e58999.js"><link rel="prefetch" href="/assets/js/41.87ee5a6e.js"><link rel="prefetch" href="/assets/js/42.dc0bc6ff.js"><link rel="prefetch" href="/assets/js/43.8afe1fbd.js"><link rel="prefetch" href="/assets/js/44.dd42bcb3.js"><link rel="prefetch" href="/assets/js/45.89bec802.js"><link rel="prefetch" href="/assets/js/46.d89df8af.js"><link rel="prefetch" href="/assets/js/47.252b6136.js"><link rel="prefetch" href="/assets/js/48.9d1bb3b5.js"><link rel="prefetch" href="/assets/js/49.903ae125.js"><link rel="prefetch" href="/assets/js/5.01b03d8b.js"><link rel="prefetch" href="/assets/js/50.df4d83a9.js"><link rel="prefetch" href="/assets/js/51.da553037.js"><link rel="prefetch" href="/assets/js/52.a2461360.js"><link rel="prefetch" href="/assets/js/53.9fb017ae.js"><link rel="prefetch" href="/assets/js/54.d14f55cf.js"><link rel="prefetch" href="/assets/js/55.f0d0480c.js"><link rel="prefetch" href="/assets/js/56.2e8e0123.js"><link rel="prefetch" href="/assets/js/57.652cb71c.js"><link rel="prefetch" href="/assets/js/58.84152000.js"><link rel="prefetch" href="/assets/js/59.9bdbe8f7.js"><link rel="prefetch" href="/assets/js/6.17f05b35.js"><link rel="prefetch" href="/assets/js/60.b6dab2bd.js"><link rel="prefetch" href="/assets/js/61.a534cf3d.js"><link rel="prefetch" href="/assets/js/62.136519bc.js"><link rel="prefetch" href="/assets/js/63.e90ff090.js"><link rel="prefetch" href="/assets/js/64.8cd98701.js"><link rel="prefetch" href="/assets/js/65.c2884dbc.js"><link rel="prefetch" href="/assets/js/66.9784539a.js"><link rel="prefetch" href="/assets/js/67.77c03cd9.js"><link rel="prefetch" href="/assets/js/68.4c2cc0fb.js"><link rel="prefetch" href="/assets/js/69.f69635d4.js"><link rel="prefetch" href="/assets/js/70.d710e533.js"><link rel="prefetch" href="/assets/js/71.4ae26767.js"><link rel="prefetch" href="/assets/js/72.cf9fed14.js"><link rel="prefetch" href="/assets/js/73.c2cf15b4.js"><link rel="prefetch" href="/assets/js/74.64eade6c.js"><link rel="prefetch" href="/assets/js/75.ce36f4ae.js"><link rel="prefetch" href="/assets/js/76.2a33c53b.js"><link rel="prefetch" href="/assets/js/77.30598a8c.js"><link rel="prefetch" href="/assets/js/78.13ea9b24.js"><link rel="prefetch" href="/assets/js/79.513e9542.js"><link rel="prefetch" href="/assets/js/8.391bc43b.js"><link rel="prefetch" href="/assets/js/80.24a46d34.js"><link rel="prefetch" href="/assets/js/81.d501b813.js"><link rel="prefetch" href="/assets/js/82.f77baa5a.js"><link rel="prefetch" href="/assets/js/83.91e67b27.js"><link rel="prefetch" href="/assets/js/84.ba3475bb.js"><link rel="prefetch" href="/assets/js/85.e8257972.js"><link rel="prefetch" href="/assets/js/86.5c268be9.js"><link rel="prefetch" href="/assets/js/87.a14bfa50.js"><link rel="prefetch" href="/assets/js/88.8351780b.js"><link rel="prefetch" href="/assets/js/89.b80410f1.js"><link rel="prefetch" href="/assets/js/9.e55936b5.js"><link rel="prefetch" href="/assets/js/90.e4767763.js"><link rel="prefetch" href="/assets/js/91.4c365bab.js"><link rel="prefetch" href="/assets/js/92.16884dfa.js"><link rel="prefetch" href="/assets/js/93.11b1a584.js"><link rel="prefetch" href="/assets/js/94.a60282fc.js"><link rel="prefetch" href="/assets/js/95.b04abb7d.js"><link rel="prefetch" href="/assets/js/96.66e176dd.js"><link rel="prefetch" href="/assets/js/97.f8b0eadc.js"><link rel="prefetch" href="/assets/js/98.4bb86b04.js"><link rel="prefetch" href="/assets/js/99.7d438189.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.0d3d3514.js">
    <link rel="stylesheet" href="/assets/css/0.styles.bc3aed26.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link"><span class="site-title" data-v-2a8e05ba>Legend Of WolfX</span></a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">
              Blog
            </a></li><li class="nav-item"><a href="/tag/" class="nav-link">
              Tags
            </a></li><li class="nav-item"><a href="/about/" class="nav-link">
              About
            </a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Legend Of WolfX </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="/about/" class="nav-link">About</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        WebAssembly 起步！
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2018-01-31T16:50:24.000Z">
      2018-02-01
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-25dfc3b6><a href="/tag/WebAssembly" data-v-25dfc3b6> WebAssembly </a></li><li class="post-tag" data-v-25dfc3b6><a href="/tag/JavaScript" data-v-25dfc3b6> JavaScript </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h1 id="了解-webassembly-原理"><a href="#了解-webassembly-原理" class="header-anchor">#</a> 了解 WebAssembly 原理</h1> <p>WebAssembly 是一种可以在浏览器上运行的二进制可执行格式文件。它将成为浏览器进化史上又一次革命。</p> <p>自从浏览器问世以来，javascript 就成为浏览器上执行程序的唯一标准，越来越多的应用程序通过 javascript 开发，并运行于浏览器上；而随着浏览器上 h5 程序功能的丰富，也对浏览器提出了更多的挑战。其中一条最为重要的就是性能问题。javascript 是一种弱类型，解释性的脚本语言。它天生运行速度慢，成为了很多 h5 应用的软肋。虽然 2008 年 google V8 引入了即时编译等技术使 js 的运行速度提升了一大截，但是一些大型应用程序，比如游戏，视频编辑，压缩，算法等依然不适合运行在浏览器上。</p> <p>WebAssembly 的到来解决了这个问题，并给开发基于浏览器的应用程序提供了另外的编程语言选择。2017 年三大浏览器同时增加了 WebAssembly 支持，标志着 WebAssembly 已经达到生产实用标准。</p> <h2 id="为什么-webassembly-比-javascript-快"><a href="#为什么-webassembly-比-javascript-快" class="header-anchor">#</a> 为什么 WebAssembly 比 javascript 快</h2> <p>回答这个问题需要洞悉浏览器执行 javascript 代码的各个环节。
浏览器加载并执行 javascript 大概可分为如下几个环节： 下载，解析，执行和优化，垃圾回收。</p> <h3 id="下载"><a href="#下载" class="header-anchor">#</a> 下载</h3> <p>javascript 是以纯文本格式下载的。相比，webassembly 使用二进制格式存储，结构更精简，更小。</p> <h3 id="解析"><a href="#解析" class="header-anchor">#</a> 解析</h3> <p>javascript 下载后，需要 js 引擎经过 tokenize, parse 两个阶段转换成 AST(abstract syntax tree)，然后再转换为浏览器需要的中间字节码。由于 js 是比较高级的语言，解析 js 也相对要做更多的事情。webassembly 的格式类似于汇编语言，本来就是中间字节码，和需要运行的机器码更相近，需要简单的转换工作即可转化为 CPU 可以直接执行的机器码。</p> <p>下图是一个真实运行的 webassembly（它是文本的，只是为了方便调试），可以看出它和汇编是很相似的，更易转化为机器码。</p> <p><img src="https://imgs-1251264059.coscd.myqcloud.com/b4b81f82-165a-6543-be8f-64f510b8b22e.jpg" alt=""></p> <h3 id="执行和优化"><a href="#执行和优化" class="header-anchor">#</a> 执行和优化</h3> <p>在执行阶段，js 普遍采用解释执行策略，相当于每一次执行 javascript 指令都要通过 js 引擎中转给 cpu。现代的 js 引擎同时采用了即时编译的策略。这需要同时运行一个 profiler，关注每个函数的调用情况。当 profiler 发现一个函数调用的比较多的时候，会把这个函数抛给编译器，为它生成一个更快的编译版本。某些情况下，参数类型会发生变化。这时，需要删除之前的编译版本，对新参数类型编译新的版本。而 webassembly 由于类汇编的结构，只需简单的编译即可转换为可直接运行在 cpu 上的机器码，执行更快。</p> <h3 id="垃圾回收"><a href="#垃圾回收" class="header-anchor">#</a> 垃圾回收</h3> <p>javascript 运行期间需要同时间歇的运行一个垃圾回收器，扫描堆上的垃圾、释放内存。垃圾回收器的运行又和 js 引擎的执行是互斥的，导致 js 执行间歇性的被垃圾回收器打断。webassembly 不负责垃圾回收，只能编程语言自行解决。于是不同的编程语言又有所不同。C/C++ 是手动管理内存 (malloc/free, new/delete)，rust 则是基于生命周期的自动内存管理。所有这些内存管理方法都不需要间歇的全局暂停。因此性能更好。</p> <p>从以上各个角度看 WebAssembly 确实比 javascript 性能高。事实上，目前阶段 WebAssembly 执行时间大概等于原生程序执行时间 X1.2。</p> <h2 id="webassembly-的加载与执行"><a href="#webassembly-的加载与执行" class="header-anchor">#</a> WebAssembly 的加载与执行</h2> <p>wasm 是 WebAssembly 格式的浏览器可执行文件。它是二进制的，但是它并不像桌面 win32 程序一样，可以随便使用系统资源，调用操作系统 api。事实上，所有与外界相关的操作都必须由 javascript 传入。比如：要申请一段内存，必须由 javascript 申请了并传给他。 浏览器上，javascript 做不到的，它也做不到；javascript 能做到的，它能做的更快。 这个就是它的价值。</p> <p>目前必须要 js 启动 WebAssembly 的加载和实例化（后面可能会有单独的加载机制）。</p> <p>如下函数，使用 fetchAPI 加载 wasm 文件，并实例化 wasm 模块。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">fetchAndInstantiate</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> importObject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">bytes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> importObject<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> results<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">fetchAndInstantiate</span><span class="token punctuation">(</span><span class="token string">&quot;module.wasm&quot;</span><span class="token punctuation">,</span> importObject<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>importObject 即浏览器需要向 webassembly 注入的交互 api。</p> <p>如下，是一个真实运行的 importObject 包括很多 js 函数。</p> <p><img src="https://imgs-1251264059.coscd.myqcloud.com/90593041-0cb5-349e-e148-f772ed0dadd1.jpg" alt=""></p> <p>注意 global.memory 就是 webassembly 程序执行用到的内存，是 js 申请的一个大的 ArrayBuffer。</p> <h1 id="学会-webassembly-开发"><a href="#学会-webassembly-开发" class="header-anchor">#</a> 学会 WebAssembly 开发</h1> <p>讲了这么多 WebAssembly 的优点，接下就讲下 WebAssembly 的开发。</p> <p>开发 WebAssembly 并不意味着需要手写 WebAssembly 汇编程序。一个开源项目 emscripten 已经提供了 sdk 可以编译 C/C++，并输出 WebAssembly 的 wasm 文件。目前，rust 也已经支持编译到 wasm。未来所有支持编译到 LLVM 字节码的编程语言，理论上都可以输出 wasm。</p> <h2 id="安装-emscripten"><a href="#安装-emscripten" class="header-anchor">#</a> 安装 emscripten</h2> <p>下载 emscripten sdk 后，是个压缩文件，其实是 sdk 包管理器。
需要执行如下命令，完成 sdk 的安装。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>./emsdk update
./emsdk <span class="token function">install</span> latest
./emsdk activate latest
<span class="token builtin class-name">source</span> ./emsdk_env.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>现在已经有个可用的 emcc 编译器了，输入：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>emcc --version
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看编译器版本。</p> <p>emsdk 安装后， emscripten 文件内是按版本号安装的 sdk 内容，里面有很多 C/C++ 用例，可以自行研究下。</p> <h2 id="简单-demo"><a href="#简单-demo" class="header-anchor">#</a> 简单 demo</h2> <p>这个简单的 C 程序可以直接编译为 wasm。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hello, world!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>./emcc hello_world.c
node a.out.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>默认情况下，emcc 只输出了一个 js（asmjs）。asmjs 是 webassembly 的一个早期原型，可提供 webassembly 在旧版本浏览器上的兼容。按如下命令输出 webassembly 二进制 wasm。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>./emcc hello_world.c -s <span class="token assign-left variable">WASM</span><span class="token operator">=</span><span class="token number">1</span> -o index.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这次编译输出了 index.html, index.js, index.wasm 三个文件。通过一个静态服务器打开 index.html，可以看到 console 里的输出。</p> <p><img src="https://imgs-1251264059.coscd.myqcloud.com/8408d849-b57b-0cf9-e801-5c0baa3da06c.jpg" alt=""></p> <p>这个 index.html 是一个调试页面。生产上加载 webassembly 一般都需要自己写 index.html，只保留 js 和 wasm 文件就够了。</p> <p>以上的例子中，printf 的标准输出被定向到了浏览器的 console 里面。 系统 API 调用被换成了 js 实现。 事实上很多 libc 里面的函数被 emscripten 实现成了浏览器上的兼容方案，从而更好的和浏览器结合。</p> <h2 id="环境"><a href="#环境" class="header-anchor">#</a> 环境</h2> <p>所有编程语言都要和它的运行环境打交道，否则除了把 cpu 跑满，没什么实用价值。跑在浏览器上的 webassembly 则是通过和 js 相互调用发挥它的作用。</p> <p>Emscripten sdk 提供了很多 API 与 js 运行环境／浏览器交互。定义在其中两个头文件中：</p> <ul><li>emscripten.h： 中定义了一些基础功能相关 API，包括调用 js，文件读写，网络请求等，这些 API 在 node 中也可以用。</li> <li>html5.h 中定义了浏览器中与 DOM 相关的各种操作，包括 DOM，事件，设备相关等。</li></ul> <p>下面，抽出一些关键的 API 讲下 webassembly 是如何与浏览器协同工作的。</p> <h3 id="调用-js"><a href="#调用-js" class="header-anchor">#</a> 调用 js</h3> <p>EM_ASM 宏，让 webassembly 可以直接调用 js。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>EM_ASM<span class="token punctuation">(</span>alert<span class="token punctuation">(</span><span class="token string">'hai'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> alert<span class="token punctuation">(</span><span class="token string">'bai'</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果需要从 js 获取执行结果，可以用 EM_ASM_INT， EM_ASM_DOUBLE 两个版本分别获取 int 和 double 类型的数值。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token function">EM_ASM_INT</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> $<span class="token number">0</span> <span class="token operator">+</span> <span class="token number">42</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果需要传递字符串给 js，可以传递一个字符串起始的指针给 js。由于 js 可以访问整个 wasm 程序的内存区域，js 用这个指针就可以从内存读出字符串。Module 对象上的<code>UTF8ToString(ptr)</code>, <code>UTF16ToString(ptr)</code>, <code>UTF32ToString(ptr)</code>, <code>Pointer_stringify(ptr, length)</code>这几个函数可获得指针处的字符串。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">char</span><span class="token operator">*</span> sample <span class="token operator">=</span> <span class="token string">&quot;This is a string&quot;</span><span class="token punctuation">;</span>
  <span class="token function">EM_ASM_</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;js got string:&quot;</span><span class="token punctuation">,</span> Module<span class="token punctuation">.</span><span class="token function">UTF8ToString</span><span class="token punctuation">(</span>$<span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> sample<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="标准输入输出"><a href="#标准输入输出" class="header-anchor">#</a> 标准输入输出</h3> <p>标准输出我们之前看过，printf 最终被转到 Module.print，默认是 console.log 实现。
标准错误输出最终会被转到 Module.printErr，默认是 console.error 实现。
对标准输入的读取在浏览器上变成了一个 prompt 框。体验不好，尽量不要读。</p> <h3 id="显示"><a href="#显示" class="header-anchor">#</a> 显示</h3> <p>Emscripten 支持两种 GUI 展示方法。</p> <ul><li>DOM： wasm 是可以调用 js 的，而 js 又可以操作 DOM。因此，wasm 可以通过 js 操作 DOM，创建程序的 GUI。</li> <li>Webgl Canvas: 除了 DOM，emscripten 还可以提供了 opengl es 的浏览器实现。通过操作一个 Webgl Canvas，把显示内容画在 Canvas 上。</li></ul> <h3 id="事件循环"><a href="#事件循环" class="header-anchor">#</a> 事件循环</h3> <p>C++ GUI 程序一般都有个事件循环，其实就是个死循环，反复获取并处理 GUI 层面上的各种事件。这样程序不会跑完 main 函数直接退出。webassembly 程序跑在浏览器上，而浏览器本来就是事件驱动，已经有了一个事件循环。假如不改动直接上浏览器，就会卡死浏览器的 GUI 进程。因此 webassembly 程序需要由浏览器控制事件循环。</p> <p><code>emscripten_set_main_loop(em_callback_func func, int fps, int simulate_infinite_loop)</code>函数接受一个函数的指针后，浏览器会根据 fps 按时调用传入的函数。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;emscripten.h&gt;</span></span>

<span class="token keyword">int</span> frame <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main_loop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;frame: %d\n&quot;</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
  frame<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">emscripten_set_main_loop</span><span class="token punctuation">(</span>main_loop<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="存储"><a href="#存储" class="header-anchor">#</a> 存储</h3> <p>浏览器隔离了程序直接操作存储的权限，因而 webapp 是安全的，但很多 C 代码都有同步操作文件的 API，如 open, write, close。为了兼容，emscripten 实现了一个内存文件系统，可以通过全局对象 FS 访问。</p> <p>下图，是 FS 对象下的函数。</p> <p><img src="https://imgs-1251264059.coscd.myqcloud.com/972ac675-c2de-ee3c-2293-72d006c73cfe.jpg" alt=""></p> <p>另外，emcc 还提供了 --preload-file 参数，在 webassembly 程序加载的过程中，预加载文件放到虚拟文件系统中。</p> <p>wasm 中的文件虽然是内存的，但是支持通过 indexDB 持久化。
如下 js，mount 一个 indexdb 的文件夹到 /data 目录，然后 FS.syncfs 把 indexdb 中的文件同步到内存。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">FS</span><span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">&quot;/data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">FS</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token constant">IDBFS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;/data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">FS</span><span class="token punctuation">.</span><span class="token function">syncfs</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来，所有，/data 目录下的读写，都在内存中的同步读写。当程序关闭的时候，需要调用<code>FS.syncfs(false, function(err){})</code>把内存中的文件反方向同步回 indexdb。</p> <h3 id="库"><a href="#库" class="header-anchor">#</a> 库</h3> <p>emsdk 提供了一些常用的 C++ 库的 webassembly 兼容版本。用<code>emcc --show-ports</code>命令显示。如果要用 SDL2，需要给 emcc 加入选项<code>-s USE_SDL=2</code>，链接 SDL2 库。</p> <p>目前，emcc 内置支持这些库。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ emcc --show-ports
Available ports:
    zlib <span class="token punctuation">(</span>USE_ZLIB<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> zlib license<span class="token punctuation">)</span>
    libpng <span class="token punctuation">(</span>USE_LIBPNG<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> zlib license<span class="token punctuation">)</span>
    SDL2 <span class="token punctuation">(</span>USE_SDL<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span> zlib license<span class="token punctuation">)</span>
    SDL2_image <span class="token punctuation">(</span>USE_SDL_IMAGE<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span> zlib license<span class="token punctuation">)</span>
    ogg <span class="token punctuation">(</span>USE_OGG<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> zlib license<span class="token punctuation">)</span>
    vorbis <span class="token punctuation">(</span>USE_VORBIS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> zlib license<span class="token punctuation">)</span>
    bullet <span class="token punctuation">(</span>USE_BULLET<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> zlib license<span class="token punctuation">)</span>
    freetype <span class="token punctuation">(</span>USE_FREETYPE<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> freetype license<span class="token punctuation">)</span>
    SDL2_ttf <span class="token punctuation">(</span>USE_SDL_TTF<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span> zlib license<span class="token punctuation">)</span>
    SDL2_net <span class="token punctuation">(</span>zlib license<span class="token punctuation">)</span>
    Binaryen <span class="token punctuation">(</span>Apache <span class="token number">2.0</span> license<span class="token punctuation">)</span>
    cocos2d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>如果所需要的库没在列表里，需要先用 emsdk 编译所需要的库（可能涉及到库的改动）。再编译并链接，输出最终目标。emcc 不支持动态链接。</p> <h1 id="webassembly-示例-c-c"><a href="#webassembly-示例-c-c" class="header-anchor">#</a> WebAssembly 示例(C/C++)</h1> <p>如果你的浏览器支持 WebAssembly，则可以直接运行下面代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>WebAssembly<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  00 61 73 6d  01 00 00 00  01 0c 02 60  02 7f 7f 01
  7f 60 01 7f  01 7f 03 03  02 00 01 07  10 02 03 61
  64 64 00 00  06 73 71 75  61 72 65 00  01 0a 13 02
  08 00 20 00  20 01 6a 0f  0b 08 00 20  00 20 00 6c
  0f 0b</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\s\r\n]+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> add<span class="token punctuation">,</span> square <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2 + 4 =&quot;</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3^2 =&quot;</span><span class="token punctuation">,</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;(2 + 5)^2 =&quot;</span><span class="token punctuation">,</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="编译器-c-c"><a href="#编译器-c-c" class="header-anchor">#</a> 编译器（C/C++）</h2> <blockquote><p>有一个在线 C++ 转 wasm 的工具： <a href="http://mbebenita.github.io/WasmExplorer/" target="_blank" rel="noopener noreferrer">WasmExplorer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><a href="http://kripken.github.io/emscripten-site/" target="_blank" rel="noopener noreferrer">Emscripten<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，它基于 LLVM ，可以将 C/C++ 编译成 asm.js，使用 WASM 标志也可以直接生成 WebAssembly 二进制文件（后缀是 .wasm）。</p> <p>注：emcc 在 1.37 以上版本才支持直接生成 wasm 文件。</p> <p>当然还有其他语言的编译器，这里只说 C/C++</p> <p>使用 <a href="http://kripken.github.io/emscripten-site/docs/getting_started/downloads.html#updating-the-emscripten-sdk" target="_blank" rel="noopener noreferrer">SDK<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方式安装更方便</p> <p>解压下载的 zip, 进入 SDK 的解压目录。逐步执行如下命令</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># Fetch the latest registry of available tools.</span>
./emsdk update

<span class="token comment"># Download and install the latest SDK tools.</span>
./emsdk <span class="token function">install</span> latest

<span class="token comment"># Make the &quot;latest&quot; SDK &quot;active&quot; for the current user. (writes ~/.emscripten file)</span>
./emsdk activate latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果 activate 无效，可以手动设置环境变量（如果已经装了 Java、Node、Python，可以省略这 3 个）：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token environment constant">PATH</span> <span class="token operator">+=</span> D:<span class="token punctuation">\</span>tools-dev<span class="token punctuation">\</span>emsdk-portable-64bit<span class="token punctuation">\</span>clang<span class="token punctuation">\</span>e1.37.28_64bit
<span class="token environment constant">PATH</span> <span class="token operator">+=</span> D:<span class="token punctuation">\</span>tools-dev<span class="token punctuation">\</span>emsdk-portable-64bit<span class="token punctuation">\</span>node<span class="token punctuation">\</span><span class="token number">4.1</span>.1_64bit<span class="token punctuation">\</span>bin
<span class="token environment constant">PATH</span> <span class="token operator">+=</span> D:<span class="token punctuation">\</span>tools-dev<span class="token punctuation">\</span>emsdk-portable-64bit<span class="token punctuation">\</span>python<span class="token punctuation">\</span><span class="token number">2.7</span>.5.3_64bit
<span class="token environment constant">PATH</span> <span class="token operator">+=</span> D:<span class="token punctuation">\</span>tools-dev<span class="token punctuation">\</span>emsdk-portable-64bit<span class="token punctuation">\</span>java<span class="token punctuation">\</span><span class="token number">7</span>.45_64bit<span class="token punctuation">\</span>bin
<span class="token environment constant">PATH</span> <span class="token operator">+=</span> D:<span class="token punctuation">\</span>tools-dev<span class="token punctuation">\</span>emsdk-portable-64bit<span class="token punctuation">\</span>emscripten<span class="token punctuation">\</span><span class="token number">1.37</span>.28
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="python-版本不对"><a href="#python-版本不对" class="header-anchor">#</a> Python 版本不对？</h2> <p>Emscripten 需要 Py2，如果你装了 Py3，则需要同时安装 Py2。</p> <p>Py2 和 Py3 在 Windows 下共存的方案，可以看这个：</p> <p><a href="http://blog.csdn.net/louishao/article/details/57075531" target="_blank" rel="noopener noreferrer">http://blog.csdn.net/louishao/article/details/57075531<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="编写-c-代码"><a href="#编写-c-代码" class="header-anchor">#</a> 编写 C 代码</h2> <p>首先新建一个 C 语言文件，假设叫 math.c 吧，在里边实现 add 和 square 方法：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// math.c</span>
<span class="token keyword">int</span> <span class="token function">add</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">square</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>然后执行 <code>emcc math.c -Os -s WASM=1 -s SIDE_MODULE=1 -o math.wasm</code> 就可以生成 wasm 文件了。</p> <h2 id="编写加载函数"><a href="#编写加载函数" class="header-anchor">#</a> 编写加载函数</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">loadWebAssembly</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token comment">// 加载文件</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 转成 ArrayBuffer</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>WebAssembly<span class="token punctuation">.</span>instantiate<span class="token punctuation">)</span> <span class="token comment">// 编译 + 实例化</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">mod</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> mod<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 提取生成都模块</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>代码其实很简单，使用了 Fetch API 来获取 wasm 文件，然后将其转换成 ArrayBuffer，然后使用
WebAssembly.instantiate 这个一步到位的方法来编译并初始化一个 WebAssembly
的实例。最后一步是从生成的模块中提取出真正的实例对象。</p> <p>完成了上边的操作，就可以直接使用 loadWebAssembly 这个方法加载 wasm 文件了，它相当于是一个 wasm-loader ；返回值是一个
Promise，使用起来和普通的 js 函数没什么区别。从 instance.exports 中可以找到 wasm 文件输出的接口。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">loadWebAssembly</span><span class="token punctuation">(</span><span class="token string">&quot;path/to/math.wasm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> add<span class="token punctuation">,</span> square <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="更完整的加载函数"><a href="#更完整的加载函数" class="header-anchor">#</a> 更完整的加载函数</h2> <p>如果你直接使用上边那个 loadWebAssembly 函数，有可能会执行失败，因为在 wasm
文件里，可能还会引入一些环境变量，在实例化的同时还需要初始化内存空间和变量映射表，也就是 WebAssembly.Memory 和
WebAssembly.Table。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/**
 * @param {String} path wasm 文件路径
 * @param {Object} imports 传递到 wasm 代码中的变量
 */</span>
<span class="token keyword">function</span> <span class="token function">loadWebAssembly</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> WebAssembly<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      imports<span class="token punctuation">.</span>env <span class="token operator">=</span> imports<span class="token punctuation">.</span>env <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">// 开辟内存空间</span>
      imports<span class="token punctuation">.</span>env<span class="token punctuation">.</span>memoryBase <span class="token operator">=</span> imports<span class="token punctuation">.</span>env<span class="token punctuation">.</span>memoryBase <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imports<span class="token punctuation">.</span>env<span class="token punctuation">.</span>memory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        imports<span class="token punctuation">.</span>env<span class="token punctuation">.</span>memory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">{</span> initial<span class="token operator">:</span> <span class="token number">256</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 创建变量映射表</span>
      imports<span class="token punctuation">.</span>env<span class="token punctuation">.</span>tableBase <span class="token operator">=</span> imports<span class="token punctuation">.</span>env<span class="token punctuation">.</span>tableBase <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imports<span class="token punctuation">.</span>env<span class="token punctuation">.</span>table<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在 MVP 版本中 element 只能是 &quot;anyfunc&quot;</span>
        imports<span class="token punctuation">.</span>env<span class="token punctuation">.</span>table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Table</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          initial<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          element<span class="token operator">:</span> <span class="token string">&quot;anyfunc&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 创建 WebAssembly 实例</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> imports<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>这个 loadWebAssembly 函数还接受第二个参数，表示要传递给 wasm 的变量，在初始化 WebAssembly 实例的时候，可以把一些接口传递给 wasm 代码。</p> <h2 id="调用-webassembly-导出的接口"><a href="#调用-webassembly-导出的接口" class="header-anchor">#</a> 调用 WebAssembly 导出的接口</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">loadWebAssembly</span><span class="token punctuation">(</span><span class="token string">&quot;./math.wasm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> add <span class="token operator">=</span> instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>_add<span class="token punctuation">;</span>
  <span class="token keyword">const</span> square <span class="token operator">=</span> instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>_square<span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2 + 4 =&quot;</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3^2 =&quot;</span><span class="token punctuation">,</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;(2 + 5)^2 =&quot;</span><span class="token punctuation">,</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>比较奇怪的一点是，用 C/C++ 导出的模块，属性名上默认都带了 <code>_</code> 前缀，asm.js 转成了 wasm 模块就不带。</p></blockquote> <h2 id="其他教程"><a href="#其他教程" class="header-anchor">#</a> 其他教程</h2> <p><a href="http://www.ruanyifeng.com/blog/2017/09/asmjs_emscripten.html" target="_blank" rel="noopener noreferrer">http://www.ruanyifeng.com/blog/2017/09/asmjs_emscripten.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://webassembly.org/docs/high-level-goals/" target="_blank" rel="noopener noreferrer">http://webassembly.org/docs/high-level-goals/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/zh-CN/docs/WebAssembly<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="webassembly-示例-assemblyscript"><a href="#webassembly-示例-assemblyscript" class="header-anchor">#</a> WebAssembly 示例(AssemblyScript)</h1> <p>之前介绍了 WebAssembly 可以用 C/C++ 和 Rust 来编写。但是如果你是熟悉 JS 的前端，不想换语言怎么办呢？</p> <p>于是 <a href="https://github.com/AssemblyScript/assemblyscript/" target="_blank" rel="noopener noreferrer">AssemblyScript<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 诞生了</p> <blockquote><p>A TypeScript to WebAssembly compiler. <a href="http://assemblyscript.org" target="_blank" rel="noopener noreferrer">http://assemblyscript.org<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/AssemblyScript/assemblyscript.git
<span class="token builtin class-name">cd</span> assemblyscript
<span class="token function">npm</span> <span class="token function">install</span>
<span class="token function">npm</span> <span class="token function">link</span> <span class="token comment"># npm link 命令可以将一个任意位置的 npm 包链接到全局执行环境，从而在任意位置使用命令行都可以直接运行该 npm 包。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="编译器的使用"><a href="#编译器的使用" class="header-anchor">#</a> 编译器的使用</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>asc yourModule.ts -b yourModule.wasm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h1 active"><a href="#了解-webassembly-原理" title="了解 WebAssembly 原理">了解 WebAssembly 原理</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#为什么-webassembly-比-javascript-快" title="为什么 WebAssembly 比 javascript 快">为什么 WebAssembly 比 javascript 快</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#下载" title="下载">下载</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#解析" title="解析">解析</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#执行和优化" title="执行和优化">执行和优化</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#垃圾回收" title="垃圾回收">垃圾回收</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#webassembly-的加载与执行" title="WebAssembly 的加载与执行">WebAssembly 的加载与执行</a></div><div class="vuepress-toc-item vuepress-toc-h1"><a href="#学会-webassembly-开发" title="学会 WebAssembly 开发">学会 WebAssembly 开发</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#安装-emscripten" title="安装 emscripten">安装 emscripten</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#简单-demo" title="简单 demo">简单 demo</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#环境" title="环境">环境</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#调用-js" title="调用 js">调用 js</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#标准输入输出" title="标准输入输出">标准输入输出</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#显示" title="显示">显示</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#事件循环" title="事件循环">事件循环</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#存储" title="存储">存储</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#库" title="库">库</a></div><div class="vuepress-toc-item vuepress-toc-h1"><a href="#webassembly-示例-c-c" title="WebAssembly 示例(C/C++)">WebAssembly 示例(C/C++)</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#编译器-c-c" title="编译器（C/C++）">编译器（C/C++）</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#python-版本不对" title="Python 版本不对？">Python 版本不对？</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#编写-c-代码" title="编写 C 代码">编写 C 代码</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#编写加载函数" title="编写加载函数">编写加载函数</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#更完整的加载函数" title="更完整的加载函数">更完整的加载函数</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#调用-webassembly-导出的接口" title="调用 WebAssembly 导出的接口">调用 WebAssembly 导出的接口</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#其他教程" title="其他教程">其他教程</a></div><div class="vuepress-toc-item vuepress-toc-h1"><a href="#webassembly-示例-assemblyscript" title="WebAssembly 示例(AssemblyScript)">WebAssembly 示例(AssemblyScript)</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#安装" title="安装">安装</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#编译器的使用" title="编译器的使用">编译器的使用</a></div></div> <div id="blog-adv" data-v-206924b9><iframe src="" frameborder="0" width="640" height="200" class="adv-iframe" data-v-206924b9></iframe></div></div></div> <footer class="footer" data-v-4ee6079d><div class="footer-right-wrap" data-v-4ee6079d><ul class="copyright" data-v-4ee6079d><li class="copyright-item" data-v-4ee6079d><a href="/" class="nav-link" data-v-4ee6079d>MIT Licensed | Copyright © 2018-present Vue.js</a></li></ul></div></footer> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1da0bb69.js" defer></script><script src="/assets/js/14.55e4c550.js" defer></script><script src="/assets/js/7.84f6b2a8.js" defer></script><script src="/assets/js/104.e613c484.js" defer></script>
  </body>
</html>
